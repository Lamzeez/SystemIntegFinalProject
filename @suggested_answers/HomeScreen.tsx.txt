// @suggested_answers/HomeScreen.tsx.txt
// This file contains the suggested changes for bao-ride-driver/src/screens/HomeScreen.tsx

import React, { useEffect, useState, useCallback } from "react";
import { View, Text, Button, StyleSheet, ActivityIndicator, Alert } from "react-native";
import { useAuth } from "../AuthContext";
import { api } from "../api";
import { getSocket } from "../socket";
import { useFocusEffect } from '@react-navigation/native';


// Define a type for the driver's status for better type safety
type DriverStatus = "online" | "offline" | "on_trip";

export default function HomeScreen({
  onRideAssigned,
}: {
  onRideAssigned: (id: number) => void;
}) {
  const { user, logout } = useAuth();
  // Default to offline, but it will be updated from the API
  const [status, setStatus] = useState<DriverStatus>("offline");
  const [loading, setLoading] = useState(true); // To show a loader while fetching initial status
  const [error, setError] = useState<string | null>(null);

  // Fetches the driver's current profile and status from the backend.
  const fetchDriverProfile = useCallback(async () => {
    try {
      setLoading(true);
      setError(null);
      const response = await api.get('/driver/profile');
      if (response.data?.driver?.status) {
        setStatus(response.data.driver.status);
      }
    } catch (e) {
      setError("Failed to fetch driver profile.");
      console.error(e);
    } finally {
      setLoading(false);
    }
  }, []);

  // useFocusEffect ensures this runs every time the screen comes into view.
  // This is useful if the driver's status could be changed from another app
  // or by an admin.
  useFocusEffect(
    useCallback(() => {
      fetchDriverProfile();
    }, [fetchDriverProfile])
  );


  // Effect for handling incoming rides via WebSocket
  useEffect(() => {
    const socket = getSocket();

    const handleIncoming = (ride: any) => {
      console.log("Ride incoming:", ride);
      Alert.alert(
        "New Ride Request",
        "You have a new ride request. Go to the Ride screen to accept it.",
        [{ text: "OK" }]
      );
      onRideAssigned(ride.id);
    };

    socket.on("ride:incoming", handleIncoming);

    // Cleanup listener on component unmount
    return () => {
      socket.off("ride:incoming", handleIncoming);
    };
  }, [onRideAssigned]);

  // Function to toggle driver status
  const toggleStatus = async () => {
    // A driver can only manually toggle between online and offline
    if (status === 'on_trip') return;

    const newStatus: DriverStatus = status === "offline" ? "online" : "offline";
    try {
      setError(null);
      await api.post("/driver/status", { status: newStatus });
      setStatus(newStatus);
    } catch {
      setError(`Failed to update status to ${newStatus}.`);
    }
  };

  if (loading) {
    return (
      <View style={styles.container}>
        <ActivityIndicator size="large" />
        <Text>Loading profile...</Text>
      </View>
    );
  }

  return (
    <View style={styles.container}>
      <Text style={styles.title}>Welcome, {user?.name}</Text>

      <View style={styles.statusContainer}>
        <Text style={styles.statusLabel}>Your Status:</Text>
        <Text style={[styles.statusValue, { color: status === 'online' ? '#28a745' : '#6c757d' }]}>
          {status.toUpperCase()}
        </Text>
      </View>

      {error && <Text style={styles.errorText}>{error}</Text>}

      {/* Show a single button to toggle status */}
      <Button
        title={status === "offline" ? "Go Online" : "Go Offline"}
        onPress={toggleStatus}
        color={status === "offline" ? "#28a745" : "#ff4d4d"}
        // Disable button if the driver is currently on a trip
        disabled={status === 'on_trip'}
      />

      {status === 'on_trip' && (
          <Text style={styles.infoText}>You are on a trip and cannot go offline.</Text>
      )}

      <View style={styles.logoutContainer}>
        <Button title="Logout" onPress={logout} color="#dc3545" />
      </View>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    padding: 20,
    alignItems: 'center',
    backgroundColor: '#f8f9fa',
  },
  title: {
    fontSize: 24,
    fontWeight: "bold",
    marginBottom: 20,
    color: '#343a40',
  },
  statusContainer: {
    flexDirection: 'row',
    alignItems: 'center',
    marginVertical: 20,
    padding: 20,
    borderRadius: 10,
    backgroundColor: 'white',
    width: '100%',
    justifyContent: 'center',
    shadowColor: '#000',
    shadowOffset: { width: 0, height: 2 },
    shadowOpacity: 0.1,
    shadowRadius: 4,
    elevation: 3,
  },
  statusLabel: {
    fontSize: 18,
    color: '#495057',
  },
  statusValue: {
    fontSize: 18,
    fontWeight: 'bold',
    marginLeft: 10,
  },
  errorText: {
    color: '#dc3545',
    marginBottom: 15,
    textAlign: 'center',
  },
  infoText: {
    color: '#6c757d',
    marginTop: 10,
    fontStyle: 'italic',
  },
  logoutContainer: {
    position: 'absolute',
    bottom: 40,
    width: '100%',
    paddingHorizontal: 20,
  },
});
