// @suggested_answers/passenger_app_HomeScreen_RideRequest.tsx.txt
// This file replaces bao-ride-passenger/src/screens/HomeScreen.tsx
//
// Prerequisite: You need to install react-native-maps and expo-location.
// In your bao-ride-passenger project directory, run:
// npm install react-native-maps expo-location
// or
// yarn add react-native-maps expo-location
//
// Also, ensure you have set up permissions in app.json for location:
// "android": {
//   "permissions": ["ACCESS_FINE_LOCATION"]
// },
// "ios": {
//   "infoPlist": {
//     "NSLocationWhenInUseUsageDescription": "This app uses your location to find nearby rides."
//   }
// }

import React, { useState, useEffect } from 'react';
import { View, Text, Button, StyleSheet, ActivityIndicator, Alert, TextInput, TouchableOpacity } from 'react-native';
import MapView, { Marker, PROVIDER_GOOGLE } from 'react-native-maps';
import * as Location from 'expo-location';
import { useAuth } from '../AuthContext';
import { api } from '../api';

interface LocationData {
  latitude: number;
  longitude: number;
  address: string;
}

export default function HomeScreen() {
  const { user, logout } = useAuth();
  const [initialRegion, setInitialRegion] = useState({
    latitude: 10.3157, // Default to Cebu City if no location
    longitude: 123.8854,
    latitudeDelta: 0.0922,
    longitudeDelta: 0.0421,
  });
  const [pickupLocation, setPickupLocation] = useState<LocationData | null>(null);
  const [dropoffLocation, setDropoffLocation] = useState<LocationData | null>(null);
  const [loadingLocation, setLoadingLocation] = useState(true);
  const [requestingRide, setRequestingRide] = useState(false);
  const [rideDetails, setRideDetails] = useState<any>(null); // To display after request

  useEffect(() => {
    (async () => {
      let { status } = await Location.requestForegroundPermissionsAsync();
      if (status !== 'granted') {
        Alert.alert('Permission denied', 'Permission to access location was denied');
        setLoadingLocation(false);
        return;
      }

      let location = await Location.getCurrentPositionAsync({});
      const currentRegion = {
        latitude: location.coords.latitude,
        longitude: location.coords.longitude,
        latitudeDelta: 0.0922,
        longitudeDelta: 0.0421,
      };
      setInitialRegion(currentRegion);
      await reverseGeocode(location.coords.latitude, location.coords.longitude, setPickupLocation);
      setLoadingLocation(false);
    })();
  }, []);

  const reverseGeocode = async (latitude: number, longitude: number, setLocation: (loc: LocationData) => void) => {
    try {
      const geocodedAddress = await Location.reverseGeocodeAsync({ latitude, longitude });
      if (geocodedAddress && geocodedAddress.length > 0) {
        const address = `${geocodedAddress[0].name}, ${geocodedAddress[0].city}, ${geocodedAddress[0].region}, ${geocodedAddress[0].country}`;
        setLocation({ latitude, longitude, address });
      }
    } catch (error) {
      console.error('Reverse geocoding error:', error);
      setLocation({ latitude, longitude, address: 'Unknown location' });
    }
  };

  const handleMapPress = (e: any) => {
    const { latitude, longitude } = e.nativeEvent.coordinate;
    if (!pickupLocation) {
      reverseGeocode(latitude, longitude, setPickupLocation);
    } else if (!dropoffLocation) {
      reverseGeocode(latitude, longitude, setDropoffLocation);
    } else {
      // If both are set, reset pickup to new selection
      setPickupLocation(null);
      setDropoffLocation(null);
      reverseGeocode(latitude, longitude, setPickupLocation);
    }
  };

  const handleDragEnd = (e: any, type: 'pickup' | 'dropoff') => {
    const { latitude, longitude } = e.nativeEvent.coordinate;
    if (type === 'pickup') {
      reverseGeocode(latitude, longitude, setPickupLocation);
    } else {
      reverseGeocode(latitude, longitude, setDropoffLocation);
    }
  };

  const handleRequestRide = async () => {
    if (!pickupLocation || !dropoffLocation) {
      Alert.alert('Error', 'Please select both pickup and drop-off locations.');
      return;
    }

    setRequestingRide(true);
    try {
      const response = await api.post('/rides/request', {
        pickup_lat: pickupLocation.latitude,
        pickup_lng: pickupLocation.longitude,
        pickup_address: pickupLocation.address,
        dropoff_lat: dropoffLocation.latitude,
        dropoff_lng: dropoffLocation.longitude,
        dropoff_address: dropoffLocation.address,
      });
      setRideDetails(response.data.ride);
      Alert.alert('Ride Requested!', 'Your ride has been requested. Searching for drivers...');
    } catch (error: any) {
      console.error('Ride request error:', error.response?.data || error.message);
      Alert.alert('Request Failed', error.response?.data?.error || 'Failed to request ride. Please try again.');
    } finally {
      setRequestingRide(false);
    }
  };

  if (loadingLocation) {
    return (
      <View style={styles.loadingContainer}>
        <ActivityIndicator size="large" />
        <Text>Loading map and your location...</Text>
      </View>
    );
  }

  return (
    <View style={styles.container}>
      <Text style={styles.title}>Welcome, {user?.name}!</Text>
      <Text style={styles.subtitle}>Request a Ride</Text>

      <MapView
        provider={PROVIDER_GOOGLE}
        style={styles.map}
        initialRegion={initialRegion}
        onPress={handleMapPress}
      >
        {pickupLocation && (
          <Marker
            coordinate={pickupLocation}
            title="Pickup"
            draggable
            onDragEnd={(e) => handleDragEnd(e, 'pickup')}
            pinColor="green"
          />
        )}
        {dropoffLocation && (
          <Marker
            coordinate={dropoffLocation}
            title="Dropoff"
            draggable
            onDragEnd={(e) => handleDragEnd(e, 'dropoff')}
            pinColor="red"
          />
        )}
      </MapView>

      <View style={styles.locationInfoContainer}>
        <View style={styles.locationInput}>
          <Text style={styles.locationLabel}>Pickup:</Text>
          <TextInput
            style={styles.addressInput}
            value={pickupLocation?.address || 'Select pickup location on map'}
            editable={false} // For now, not editable, only via map
          />
        </View>
        <View style={styles.locationInput}>
          <Text style={styles.locationLabel}>Dropoff:</Text>
          <TextInput
            style={styles.addressInput}
            value={dropoffLocation?.address || 'Select drop-off location on map'}
            editable={false} // For now, not editable, only via map
          />
        </View>
      </View>

      <Button
        title={requestingRide ? "Requesting Ride..." : "Request Ride"}
        onPress={handleRequestRide}
        disabled={requestingRide || !pickupLocation || !dropoffLocation}
      />

      {rideDetails && (
        <View style={styles.rideDetails}>
          <Text style={styles.rideDetailsText}>Ride ID: {rideDetails.id}</Text>
          <Text style={styles.rideDetailsText}>Status: {rideDetails.status}</Text>
          <Text style={styles.rideDetailsText}>Estimated Fare: â‚±{rideDetails.estimated_fare?.toFixed(2)}</Text>
        </View>
      )}

      <View style={styles.logoutButtonContainer}>
        <Button title="Logout" onPress={logout} color="#dc3545" />
      </View>
    </View>
  );
}

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: '#f0f2f5',
    paddingTop: 50, // Adjust for status bar
  },
  loadingContainer: {
    flex: 1,
    justifyContent: 'center',
    alignItems: 'center',
    backgroundColor: '#f0f2f5',
  },
  title: {
    fontSize: 26,
    fontWeight: 'bold',
    marginBottom: 5,
    textAlign: 'center',
    color: '#333',
  },
  subtitle: {
    fontSize: 18,
    color: '#666',
    marginBottom: 15,
    textAlign: 'center',
  },
  map: {
    width: '100%',
    height: '50%', // Occupy half of the screen
    marginBottom: 15,
  },
  locationInfoContainer: {
    width: '100%',
    paddingHorizontal: 20,
    marginBottom: 15,
  },
  locationInput: {
    flexDirection: 'row',
    alignItems: 'center',
    marginBottom: 10,
  },
  locationLabel: {
    fontWeight: 'bold',
    marginRight: 10,
    fontSize: 16,
    color: '#555',
  },
  addressInput: {
    flex: 1,
    borderWidth: 1,
    borderColor: '#ccc',
    borderRadius: 5,
    padding: 10,
    backgroundColor: 'white',
    fontSize: 14,
  },
  rideDetails: {
    marginTop: 20,
    padding: 15,
    backgroundColor: 'white',
    borderRadius: 8,
    borderWidth: 1,
    borderColor: '#e0e0e0',
    width: '90%',
    alignItems: 'center',
  },
  rideDetailsText: {
    fontSize: 16,
    marginBottom: 5,
    color: '#333',
  },
  logoutButtonContainer: {
    marginTop: 20,
    width: '90%',
    alignSelf: 'center',
  }
});
